name: Package Meshtracer

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: package-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  PYINSTALLER_VERSION: "6.11.1"
  PYINSTALLER_HOOKS_VERSION: "2025.1"
  APPIMAGETOOL_VERSION: "continuous"

jobs:
  build:
    name: Build (${{ matrix.os }} / ${{ matrix.artifact_arch }})
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            artifact_os: windows
            artifact_arch: x86_64
          - os: macos-15-intel
            artifact_os: macos
            artifact_arch: x86_64
          - os: macos-14
            artifact_os: macos
            artifact_arch: arm64
          - os: ubuntu-22.04
            artifact_os: linux
            artifact_arch: x86_64

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install deps
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install \
            backports.tarfile \
            pyinstaller==${{ env.PYINSTALLER_VERSION }} \
            pyinstaller-hooks-contrib==${{ env.PYINSTALLER_HOOKS_VERSION }}

      - name: Run tests
        shell: bash
        run: |
          python -m unittest discover -s tests -q

      - name: Build standalone binary (PyInstaller)
        shell: bash
        run: |
          # --add-data separator differs: Windows uses ;, others use :
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            ADD_DATA="meshtracer_app/static;meshtracer_app/static"
          else
            ADD_DATA="meshtracer_app/static:meshtracer_app/static"
          fi

          pyinstaller --noconfirm --clean --onefile \
            --name meshtracer \
            --collect-submodules meshtastic \
            --collect-submodules backports \
            --hidden-import backports \
            --hidden-import backports.tarfile \
            --add-data "$ADD_DATA" \
            meshtracer.py

      - name: Package artifact
        shell: bash
        env:
          ARTIFACT_OS: ${{ matrix.artifact_os }}
          ARTIFACT_ARCH: ${{ matrix.artifact_arch }}
          APPIMAGETOOL_VERSION: ${{ env.APPIMAGETOOL_VERSION }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import shutil
          import subprocess
          import textwrap
          import urllib.request
          import zipfile

          runner_os = os.environ["RUNNER_OS"]
          artifact_os = os.environ["ARTIFACT_OS"]
          artifact_arch = os.environ["ARTIFACT_ARCH"]
          ref = os.environ.get("GITHUB_REF", "")
          ref_name = os.environ.get("GITHUB_REF_NAME", "")
          sha = os.environ.get("GITHUB_SHA", "")

          version = ref_name if ref.startswith("refs/tags/") else (sha[:7] or "dev")

          dist = pathlib.Path("dist")
          out_dir = pathlib.Path("out")
          out_dir.mkdir(exist_ok=True)

          if runner_os == "Windows":
              exe = dist / "meshtracer.exe"
              pkg = out_dir / f"meshtracer-{version}-{artifact_os}-{artifact_arch}.zip"
              with zipfile.ZipFile(pkg, "w", compression=zipfile.ZIP_DEFLATED) as zf:
                  zf.write(exe, arcname="meshtracer.exe")
              print("Created", pkg)

          elif runner_os == "macOS":
              bin_path = dist / "meshtracer"
              pkg = out_dir / f"meshtracer-{version}-{artifact_os}-{artifact_arch}.zip"
              with zipfile.ZipFile(pkg, "w", compression=zipfile.ZIP_DEFLATED) as zf:
                  zf.write(bin_path, arcname="meshtracer")
              print("Created", pkg)

          elif runner_os == "Linux":
              if artifact_arch != "x86_64":
                  raise SystemExit(f"Linux AppImage build is only configured for x86_64, got {artifact_arch}")

              appdir = pathlib.Path("AppDir")
              (appdir / "usr/bin").mkdir(parents=True, exist_ok=True)
              shutil.copy2(dist / "meshtracer", appdir / "usr/bin/meshtracer")
              os.chmod(appdir / "usr/bin/meshtracer", 0o755)

              (appdir / "AppRun").write_text(textwrap.dedent("""\
                  #!/bin/sh
                  HERE="$(dirname "$(readlink -f "$0")")"
                  exec "$HERE/usr/bin/meshtracer" "$@"
              """), encoding="utf-8")
              os.chmod(appdir / "AppRun", 0o755)

              (appdir / "meshtracer.desktop").write_text(textwrap.dedent("""\
                  [Desktop Entry]
                  Type=Application
                  Name=Meshtracer
                  Exec=meshtracer
                  Icon=meshtracer
                  Categories=Network;
                  Terminal=true
              """), encoding="utf-8")

              (appdir / "meshtracer.svg").write_text(textwrap.dedent("""\
                  <svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
                    <rect width="256" height="256" rx="40" fill="#111"/>
                    <circle cx="78" cy="128" r="22" fill="#fff"/>
                    <circle cx="128" cy="84" r="22" fill="#fff"/>
                    <circle cx="178" cy="128" r="22" fill="#fff"/>
                    <path d="M78 128 L128 84 L178 128" stroke="#fff" stroke-width="12" fill="none" stroke-linecap="round"/>
                    <text x="128" y="200" font-family="Arial, sans-serif" font-size="28" text-anchor="middle" fill="#fff">meshtracer</text>
                  </svg>
              """), encoding="utf-8")

              appimage_version = os.environ["APPIMAGETOOL_VERSION"]
              tool_url = f"https://github.com/AppImage/AppImageKit/releases/download/{appimage_version}/appimagetool-x86_64.AppImage"
              tool = pathlib.Path("appimagetool-x86_64.AppImage")
              urllib.request.urlretrieve(tool_url, tool)
              tool.chmod(0o755)

              subprocess.check_call([str(tool.resolve()), "--appimage-extract"])
              appimage_path = out_dir / f"meshtracer-{version}-{artifact_os}-{artifact_arch}.AppImage"
              subprocess.check_call(["./squashfs-root/AppRun", str(appdir), str(appimage_path)])
              appimage_path.chmod(0o755)
              print("Created", appimage_path)

          else:
              raise SystemExit(f"Unsupported OS: {runner_os}")
          PY

      - uses: actions/upload-artifact@v4
        with:
          name: meshtracer-${{ matrix.artifact_os }}-${{ matrix.artifact_arch }}
          path: out/*
          if-no-files-found: error
          retention-days: 14

  release:
    name: Create GitHub Release
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Generate SHA256 checksums
        shell: bash
        run: |
          cd release-assets
          sha256sum * > SHA256SUMS.txt

      - uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*
